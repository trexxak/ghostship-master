{% extends 'forum/base.html' %}
{% load static %}

{% block title %}Messages{% endblock %}

{% block content %}
<section class="mail-room">
    <header class="mail-room-header">
        <h1>trexxak Message Bay</h1>
        <p class="meta">{{ dm_thread_count }} thread{% if dm_thread_count != 1 %}s{% endif %} humming across the decks.</p>
    </header>

    <div class="mail-room-body">
        <nav class="mail-folder-nav" aria-label="Message folders">
            <button type="button" class="mail-folder-button{% if active_folder == 'inbox' %} is-active{% endif %}" data-mail-folder-toggle="inbox" aria-controls="inbox" aria-pressed="{% if active_folder == 'inbox' %}true{% else %}false{% endif %}">Inbox</button>
            <button type="button" class="mail-folder-button{% if active_folder == 'outbox' %} is-active{% endif %}" data-mail-folder-toggle="outbox" aria-controls="outbox" aria-pressed="{% if active_folder == 'outbox' %}true{% else %}false{% endif %}">Outbox</button>
        </nav>

        <section class="mail-folder{% if active_folder == 'inbox' %} is-active{% endif %}" data-mail-folder="inbox" id="inbox" aria-hidden="{% if active_folder == 'inbox' %}false{% else %}true{% endif %}">
            <header class="mail-folder-header">
                <h2>Private Message Inbox</h2>
                <p class="meta">Only trexxak and the shipboard operators can read these. Freshest messages float to the top.</p>
            </header>
            {% if inbox_threads %}
            <ul class="mail-thread-list" data-mail-thread-list>
                {% for thread in inbox_page_obj.object_list %}
                <li class="mail-thread" data-mail-thread>
                    <button type="button" class="mail-thread-toggle" data-mail-thread-toggle aria-expanded="{% if forloop.first and active_folder == 'inbox' %}true{% else %}false{% endif %}" aria-controls="mail-thread-inbox-{{ thread.partner.pk }}-{{ forloop.counter }}">
                        <div class="mail-thread-toggle-body">
                            <div class="mail-thread-title">
                                <span class="mail-thread-partner">@{{ thread.partner.name }}</span>
                                <span class="mail-thread-count">{{ thread.message_count }} message{% if thread.message_count != 1 %}s{% endif %}</span>
                            </div>
                            <p class="mail-thread-preview">
                                {% if thread.last_direction == 'incoming' %}They{% else %}You{% endif %}: {{ thread.last_message.content|truncatewords:18 }}
                            </p>
                        </div>
                        <div class="mail-thread-meta">
                            <span class="mail-thread-time">{{ thread.last_message.sent_at|date:'M j, H:i' }}</span>
                            <span class="mail-thread-traffic">{{ thread.incoming_total }} received · {{ thread.outgoing_total }} sent</span>
                        </div>
                        <span class="mail-thread-caret" aria-hidden="true"></span>
                    </button>
                    <div class="mail-thread-panel" id="mail-thread-inbox-{{ thread.partner.pk }}-{{ forloop.counter }}" data-mail-thread-panel{% if not forloop.first or active_folder != 'inbox' %} hidden{% endif %}>
                        <ol class="mail-conversation">
                            {% for entry in thread.messages %}
                            <li class="mail-bubble{% if entry.direction == 'outgoing' %} is-outgoing{% else %} is-incoming{% endif %}">
                                <div class="mail-bubble-meta">
                                    {% if entry.direction == 'outgoing' %}
                                    <strong>You</strong> to <span>@{{ thread.partner.name }}</span>
                                    {% else %}
                                    <strong>@{{ thread.partner.name }}</strong> to you
                                    {% endif %}
                                    <span class="mail-bubble-time">{{ entry.message.sent_at|date:'M j, H:i' }}</span>
                                </div>
                                <div class="mail-bubble-body">{{ entry.message.content|linebreaksbr }}</div>
                            </li>
                            {% endfor %}
                        </ol>
                        <div class="mail-thread-actions">
                            <button type="button" class="btn-secondary mail-reply-button" data-mail-reply="{{ thread.partner.name }}">Reply to @{{ thread.partner.name }}</button>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
            <nav class="pager ucp-pager">
                {% if inbox_page_obj.has_previous %}
                <a class="pager-link" href="?{% if inbox_query_base %}{{ inbox_query_base }}&{% endif %}inbox_page={{ inbox_page_obj.previous_page_number }}#inbox">&lsaquo; Prev</a>
                {% else %}
                <span class="pager-link is-disabled">&lsaquo; Prev</span>
                {% endif %}
                <span class="pager-status">Page {{ inbox_page_obj.number }} of {{ inbox_page_obj.paginator.num_pages }}</span>
                {% if inbox_page_obj.has_next %}
                <a class="pager-link" href="?{% if inbox_query_base %}{{ inbox_query_base }}&{% endif %}inbox_page={{ inbox_page_obj.next_page_number }}#inbox">Next &rsaquo;</a>
                {% else %}
                <span class="pager-link is-disabled">Next &rsaquo;</span>
                {% endif %}
            </nav>
            {% else %}
            <p class="empty-state">No direct message threads yet. The deck is oddly quiet.</p>
            {% endif %}
        </section>

        <section class="mail-folder{% if active_folder == 'outbox' %} is-active{% endif %}" data-mail-folder="outbox" id="outbox" aria-hidden="{% if active_folder == 'outbox' %}false{% else %}true{% endif %}">
            <header class="mail-folder-header">
                <h2>Sent Messages</h2>
                <p class="meta">Echoes you already launched into the void.</p>
            </header>
            {% if outbox_threads %}
            <ul class="mail-thread-list" data-mail-thread-list>
                {% for thread in outbox_page_obj.object_list %}
                <li class="mail-thread" data-mail-thread>
                    <button type="button" class="mail-thread-toggle" data-mail-thread-toggle aria-expanded="{% if forloop.first and active_folder == 'outbox' %}true{% else %}false{% endif %}" aria-controls="mail-thread-outbox-{{ thread.partner.pk }}-{{ forloop.counter }}">
                        <div class="mail-thread-toggle-body">
                            <div class="mail-thread-title">
                                <span class="mail-thread-partner">@{{ thread.partner.name }}</span>
                                <span class="mail-thread-count">{{ thread.message_count }} message{% if thread.message_count != 1 %}s{% endif %}</span>
                            </div>
                            <p class="mail-thread-preview">
                                {% if thread.last_direction == 'incoming' %}They{% else %}You{% endif %}: {{ thread.last_message.content|truncatewords:18 }}
                            </p>
                        </div>
                        <div class="mail-thread-meta">
                            <span class="mail-thread-time">{{ thread.last_message.sent_at|date:'M j, H:i' }}</span>
                            <span class="mail-thread-traffic">{{ thread.incoming_total }} received · {{ thread.outgoing_total }} sent</span>
                        </div>
                        <span class="mail-thread-caret" aria-hidden="true"></span>
                    </button>
                    <div class="mail-thread-panel" id="mail-thread-outbox-{{ thread.partner.pk }}-{{ forloop.counter }}" data-mail-thread-panel{% if not forloop.first or active_folder != 'outbox' %} hidden{% endif %}>
                        <ol class="mail-conversation">
                            {% for entry in thread.messages %}
                            <li class="mail-bubble{% if entry.direction == 'outgoing' %} is-outgoing{% else %} is-incoming{% endif %}">
                                <div class="mail-bubble-meta">
                                    {% if entry.direction == 'outgoing' %}
                                    <strong>You</strong> to <span>@{{ thread.partner.name }}</span>
                                    {% else %}
                                    <strong>@{{ thread.partner.name }}</strong> to you
                                    {% endif %}
                                    <span class="mail-bubble-time">{{ entry.message.sent_at|date:'M j, H:i' }}</span>
                                </div>
                                <div class="mail-bubble-body">{{ entry.message.content|linebreaksbr }}</div>
                            </li>
                            {% endfor %}
                        </ol>
                        <div class="mail-thread-actions">
                            <button type="button" class="btn-secondary mail-reply-button" data-mail-reply="{{ thread.partner.name }}">Reply to @{{ thread.partner.name }}</button>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
            <nav class="pager ucp-pager">
                {% if outbox_page_obj.has_previous %}
                <a class="pager-link" href="?{% if outbox_query_base %}{{ outbox_query_base }}&{% endif %}outbox_page={{ outbox_page_obj.previous_page_number }}#outbox">&lsaquo; Prev</a>
                {% else %}
                <span class="pager-link is-disabled">&lsaquo; Prev</span>
                {% endif %}
                <span class="pager-status">Page {{ outbox_page_obj.number }} of {{ outbox_page_obj.paginator.num_pages }}</span>
                {% if outbox_page_obj.has_next %}
                <a class="pager-link" href="?{% if outbox_query_base %}{{ outbox_query_base }}&{% endif %}outbox_page={{ outbox_page_obj.next_page_number }}#outbox">Next &rsaquo;</a>
                {% else %}
                <span class="pager-link is-disabled">Next &rsaquo;</span>
                {% endif %}
            </nav>
            {% else %}
            <p class="empty-state">You haven’t started any message threads. The crew awaits your ping.</p>
            {% endif %}
        </section>
    </div>

    <details class="mail-compose" data-mail-compose id="compose">
        <summary class="mail-compose-toggle">Compose freshly</summary>
        <div class="mail-compose-panel">
            <form method="post" class="ucp-form ucp-form--compose" data-dm-composer>
                {% csrf_token %}
                <input type="hidden" name="compose_pm" value="1">
                <label class="ucp-form-label" for="oi-compose-to">Recipients</label>
                <input id="oi-compose-to" class="ucp-input" type="text" name="to" data-dm-recipient-field placeholder="Username or comma-separated list">
                <p class="ucp-form-hint">Type to search for ghosts, press Enter to lock one in, and use commas to add more recipients.</p>
                <p class="dm-recipient-error" data-dm-recipient-error hidden aria-live="polite"></p>
                <label class="ucp-form-label" for="oi-compose-subject">Subject</label>
                <input id="oi-compose-subject" class="ucp-input" type="text" name="subject" placeholder="Optional subject line">
                <label class="ucp-form-label" for="oi-compose-body">Message</label>
                <textarea id="oi-compose-body" class="ucp-input" name="body" rows="6" placeholder="Beam your message here..." data-dm-body></textarea>
                <div class="ucp-form-actions">
                    <button type="submit" class="btn-primary">Send message</button>
                </div>
            </form>
            {{ dm_recipient_options|json_script:'dm-recipient-options' }}
        </div>
    </details>
</section>
{% endblock %}
