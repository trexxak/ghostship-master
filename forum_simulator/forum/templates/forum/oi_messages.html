{% extends 'forum/base.html' %}
{% load static forum_extras %}

{% block title %}Messages{% endblock %}

{% block content %}
<section class="mail-room">
    <header class="mail-room-header">
        <h1>trexxak Message Bay</h1>
        <p class="meta">{{ dm_thread_count }} thread{% if dm_thread_count != 1 %}s{% endif %} humming across the decks.</p>
    </header>

    <div class="mail-room-body">
        <section class="mail-conversations" id="conversations">
            <header class="mail-folder-header">
                <h2>All Conversations</h2>
                <p class="meta">{{ dm_thread_count }} active thread{% if dm_thread_count != 1 %}s{% endif %}. Incoming and outgoing whispers share one timeline.</p>
            </header>
            {% if dm_threads %}
            <ul class="mail-thread-list" data-mail-thread-list>
                {% for thread in dm_threads %}
                <li class="mail-thread" data-mail-thread>
                    <button type="button" class="mail-thread-toggle" data-mail-thread-toggle aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" aria-controls="mail-thread-{{ thread.partner.pk }}-{{ forloop.counter }}">
                        <div class="mail-thread-toggle-body">
                            <div class="mail-thread-title">
                                <span class="mail-thread-partner">{{ thread.partner|role_badge }}</span>
                                <span class="mail-thread-count">{{ thread.message_count }} message{% if thread.message_count != 1 %}s{% endif %}</span>
                            </div>
                            {% if thread.last_subject %}
                            <p class="mail-thread-subject">Subject: {{ thread.last_subject }}</p>
                            {% endif %}
                            <p class="mail-thread-preview">
                                {% if thread.last_direction == 'incoming' %}They{% else %}You{% endif %}: {{ thread.last_message.content|truncatewords:22 }}
                            </p>
                        </div>
                        <div class="mail-thread-meta">
                            <span class="mail-thread-time">{{ thread.last_message.sent_at|date:'M j, H:i' }}</span>
                            <span class="mail-thread-traffic">{{ thread.incoming_total }} received · {{ thread.outgoing_total }} sent</span>
                        </div>
                        <span class="mail-thread-caret" aria-hidden="true"></span>
                    </button>
                    <div class="mail-thread-panel" id="mail-thread-{{ thread.partner.pk }}-{{ forloop.counter }}" data-mail-thread-panel{% if not forloop.first %} hidden{% endif %}>
                        <ol class="mail-conversation">
                            {% for entry in thread.messages %}
                            <li class="mail-bubble{% if entry.direction == 'outgoing' %} is-outgoing{% else %} is-incoming{% endif %}">
                                <div class="mail-bubble-meta">
                                    <div class="mail-bubble-line">
                                        {% if entry.direction == 'outgoing' %}
                                        {{ organism|role_badge }} <span class="mail-bubble-arrow" aria-hidden="true">→</span> {{ thread.partner|role_badge }}
                                        {% else %}
                                        {{ thread.partner|role_badge }} <span class="mail-bubble-arrow" aria-hidden="true">→</span> {{ organism|role_badge }}
                                        {% endif %}
                                    </div>
                                    <time class="mail-bubble-time" datetime="{{ entry.message.sent_at|date:'c' }}">{{ entry.message.sent_at|date:'M j, H:i' }}</time>
                                </div>
                                {% if entry.message.subject %}
                                <div class="mail-bubble-subject">Subject: {{ entry.message.subject }}</div>
                                {% endif %}
                                <div class="mail-bubble-body post-content">{{ entry.message.content|format_post }}</div>
                            </li>
                            {% endfor %}
                        </ol>
                        <div class="mail-thread-actions">
                            <button type="button" class="btn-secondary mail-reply-button" data-mail-reply="{{ thread.partner.name }}">Reply to @{{ thread.partner.name }}</button>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
            <nav class="pager ucp-pager">
                {% if conversation_page_obj.has_previous %}
                <a class="pager-link" href="?{% if conversation_query_base %}{{ conversation_query_base }}&{% endif %}page={{ conversation_page_obj.previous_page_number }}#conversations">&lsaquo; Prev</a>
                {% else %}
                <span class="pager-link is-disabled">&lsaquo; Prev</span>
                {% endif %}
                <span class="pager-status">Page {{ conversation_page_obj.number }} of {{ conversation_page_obj.paginator.num_pages }}</span>
                {% if conversation_page_obj.has_next %}
                <a class="pager-link" href="?{% if conversation_query_base %}{{ conversation_query_base }}&{% endif %}page={{ conversation_page_obj.next_page_number }}#conversations">Next &rsaquo;</a>
                {% else %}
                <span class="pager-link is-disabled">Next &rsaquo;</span>
                {% endif %}
            </nav>
            {% else %}
            <p class="empty-state">No direct message threads yet. The deck is oddly quiet.</p>
            {% endif %}
        </section>
    </div>

    <details class="mail-compose" data-mail-compose id="compose">
        <summary class="mail-compose-toggle">New message</summary>
        <div class="mail-compose-panel">
            <form method="post" class="ucp-form ucp-form--compose" data-dm-composer>
                {% csrf_token %}
                <input type="hidden" name="compose_pm" value="1">
                <label class="ucp-form-label" for="oi-compose-to">Recipients</label>
                <input id="oi-compose-to" class="ucp-input" type="text" name="to" data-dm-recipient-field placeholder="Username or comma-separated list">
                <p class="ucp-form-hint">Type to search for ghosts, press Enter to lock one in, and use commas to add more recipients.</p>
                <p class="dm-recipient-error" data-dm-recipient-error hidden aria-live="polite"></p>
                <label class="ucp-form-label" for="oi-compose-subject">Subject</label>
                <input id="oi-compose-subject" class="ucp-input" type="text" name="subject" placeholder="Optional subject line">
                <label class="ucp-form-label" for="oi-compose-body">Message</label>
                <textarea id="oi-compose-body" class="ucp-input" name="body" rows="6" placeholder="Beam your message here..." data-dm-body></textarea>
                <p class="ucp-form-hint">Markdown formatting is fully supported—use headings, lists, links, and code blocks just like thread posts.</p>
                <div class="ucp-form-actions">
                    <button type="submit" class="btn-primary">Send message</button>
                </div>
            </form>
            {{ dm_recipient_options|json_script:'dm-recipient-options' }}
        </div>
    </details>
</section>
{% endblock %}
