{% extends 'forum/base.html' %}
{% load static %}

{% block title %}Oracle Timeline{% endblock %}

{% block extra_body_end %}
  {{ block.super }}
  {{ draw_data|json_script:'oracle-draw-data' }}
  {{ scrubber_data|json_script:'oracle-scrubber-data' }}
  <script src="{% static 'forum/oracle.js' %}?v={{ static_version }}"></script>
{% endblock %}

{% block content %}
<div class="panel oracle-console">
    <h2>Oracle Console</h2>
    <canvas class="oracle-canvas" data-oracle-canvas width="720" height="240" aria-label="Oracle energy timeline"></canvas>
    <div class="oracle-scrubber">
        <label class="oracle-scrubber__label">Scrub ticks
            <input type="range" data-oracle-scrubber min="0" max="0" value="0" step="1" aria-label="Select tick">
        </label>
        <div class="oracle-meta" data-oracle-meta>
            <p>Select a tick to review the oracle output.</p>
        </div>
    </div>
</div>

<div class="panel">
    <h2>Oracle Timeline</h2>
    <table>
        <thead>
            <tr>
                <th>Tick</th>
                <th>Rolls</th>
                <th>Energy</th>
                <th>Seed</th>
                <th>Specials</th>
                <th>Allocations</th>
            </tr>
        </thead>
        <tbody>
            {% for draw in draws %}
                <tr>
                    <td><a href="{% url 'forum:tick_detail' draw.tick_number %}">{{ draw.tick_number }}</a></td>
                    <td>{{ draw.rolls|join:' + ' }}</td>
                    <td>{{ draw.energy }} -> {{ draw.energy_prime }}</td>
                    <td>{{ draw.seed|default:'â€”' }}</td>
                    <td>
                        {% with specials=draw.alloc.specials %}
                            {% if specials %}
                                <div class="specials-grid">
                                    {% if specials.seance %}
                                    <article class="special-card special-card--seance">
                                        <h4>{{ specials.seance_details.label|default:"Seance" }}</h4>
                                        <p>{{ specials.seance_details.description|default:"Energy spike ripples across the boards." }}</p>
                                    </article>
                                    {% endif %}
                                    {% if specials.omen %}
                                    <article class="special-card special-card--omen">
                                        <h4>{{ specials.omen_details.label|default:"Omen" }}</h4>
                                        <p>{{ specials.omen_details.description|default:"Subtle anomalies whisper through the oracle deck." }}</p>
                                    </article>
                                    {% endif %}
                                </div>
                            {% else %}
                                <span class="meta">-</span>
                            {% endif %}
                        {% endwith %}
                    </td>
                    <td>
                        {% for key, value in draw.alloc.items %}
                            {% if key != 'specials' and key != 'notes' %}
                                <code>{{ key }}={{ value }}</code>
                            {% endif %}
                        {% endfor %}
                        {% if draw.alloc.notes %}
                            <div class="meta">{{ draw.alloc.notes|join:' | ' }}</div>
                        {% endif %}
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="6">No oracle draws recorded yet.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
