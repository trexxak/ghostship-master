{% extends 'forum/base.html' %}

{% block title %}Tick {{ tick.tick_number }} Detail{% endblock %}

{% block extra_body_end %}
  {{ block.super }}
  {{ tick.events|json_script:'tick-events' }}
  {{ tick.decision_trace|json_script:'tick-decision-trace' }}
  {{ tick.config_snapshot|json_script:'tick-config' }}
  <script>
    (function() {
      function renderEntries(container, entries) {
        if (!container) {
          return;
        }
        container.innerHTML = '';
        if (!entries || !entries.length) {
          const empty = document.createElement('p');
          empty.className = 'meta';
          empty.textContent = 'No entries recorded.';
          container.appendChild(empty);
          return;
        }
        entries.forEach(function(entry) {
          const block = document.createElement('details');
          block.className = 'tick-entry';
          block.open = false;
          const summary = document.createElement('summary');
          summary.textContent = (entry.type || entry.phase || 'entry') + (entry.tick ? ' #' + entry.tick : '');
          block.appendChild(summary);
          const pre = document.createElement('pre');
          pre.textContent = JSON.stringify(entry, null, 2);
          block.appendChild(pre);
          container.appendChild(block);
        });
      }

      function parseScript(id) {
        const el = document.getElementById(id);
        if (!el) {
          return null;
        }
        try {
          return JSON.parse(el.textContent);
        } catch (err) {
          console.warn('Failed to parse', id, err);
          return null;
        }
      }

      renderEntries(document.querySelector('[data-events-container]'), parseScript('tick-events'));
      renderEntries(document.querySelector('[data-decision-container]'), parseScript('tick-decision-trace'));
      const configTarget = document.querySelector('[data-tick-config]');
      const configData = parseScript('tick-config');
      if (configTarget) {
        configTarget.textContent = configData ? JSON.stringify(configData, null, 2) : 'No snapshot recorded.';
      }
    })();
  </script>
{% endblock %}

{% block content %}
<div class="panel">
    <h2>Tick {{ tick.tick_number }}</h2>
    <dl class="tick-meta">
        <dt>Executed</dt>
        <dd>{{ tick.timestamp|date:'Y-m-d H:i:s' }}</dd>
        <dt>Seed</dt>
        <dd>{{ tick.seed|default:'—' }}</dd>
        {% if oracle %}
        <dt>Energy</dt>
        <dd>{{ oracle.energy }} → {{ oracle.energy_prime }}</dd>
        <dt>Card</dt>
        <dd>{{ oracle.card|default:'—' }}</dd>
        {% endif %}
    </dl>
    <details class="tick-config">
        <summary>Configuration snapshot</summary>
        <pre data-tick-config class="tick-config__body"></pre>
    </details>
</div>

<div class="panel">
    <h3>Decision Trace</h3>
    <div class="tick-log" data-decision-container></div>
</div>

<div class="panel">
    <h3>Event Log</h3>
    <div class="tick-log" data-events-container></div>
</div>
{% endblock %}
